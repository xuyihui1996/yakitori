# 🎯 优化策略总结：旋转 + 区域切分

## 你的两个建议评估

### ✅ 策略 1：先旋转再识别

**评价：⭐⭐⭐⭐⭐ 强烈推荐，立即实施！**

#### 为什么这个策略如此重要？

1. **根本原因**：你的照片是横向拍摄的（1193 x 895）
   ```
   当前：横向图片 + 竖排文字 = Vision 混淆
   优化：竖向图片 + 竖排文字 = Vision 理解 ✅
   ```

2. **阈值问题**：
   ```typescript
   // 当前（横向）
   列间距阈值 = 1193 * 3% = 35.8px  // 太大！
   结果：16 列被识别，但应该是 8-10 列
   
   // 旋转后（竖向）
   列间距阈值 = 895 * 3% = 26.8px  // 更合理！
   结果：列分组更准确
   ```

3. **坐标直观性**：
   ```
   竖向图片：
   X 轴 = 列（左→右，串焼、揚物、飯物...）
   Y 轴 = 行（上→下，菜名从上往下）
   完美匹配竖排菜单的实际布局！
   ```

#### 实施成本

- **开发成本**：✅ 已完成（`imagePreprocess.ts`）
- **API 成本**：✅ 0（只是预处理）
- **性能成本**：✅ 可忽略（~50ms）
- **维护成本**：✅ 极低

#### 预期收益

| 指标 | 当前 | 预期 | 提升 |
|-----|------|------|------|
| 价格列识别 | 0 个 | 4-6 个 | ∞% |
| 列分组准确度 | 低 | 高 | +50% |
| 整体准确率 | ~10% | 30-50% | +3-5x |

#### 如何使用

```bash
# 启用旋转
npm run parse:menu './菜单.png' -- --rotate

# 旋转 + 增强
npm run parse:menu './菜单.png' -- --rotate --enhance
```

---

### ✅ 策略 2：区域切分

**评价：⭐⭐⭐⭐ 非常推荐，配合旋转效果更佳！**

#### 为什么区域切分有效？

1. **降低复杂度**：
   ```
   完整菜单：
   - 576 words → 190 items
   - 16 列 → 难以准确分类
   - 价格列识别失败
   
   切分后（每个区域）：
   - ~150 words → ~50 items ✅
   - 2-3 列 → 容易分类 ✅
   - 价格列识别成功 ✅
   ```

2. **专注处理**：
   ```typescript
   {
     category: '串焼',
     columns: ['菜名列', '价格列'],  // 明确的结构
     items: [...] // 精准识别
   }
   ```

3. **并行处理**：
   ```typescript
   // 4 个区域可以并行识别
   const results = await Promise.all([
     parseRegion('串焼'),
     parseRegion('揚物'),
     parseRegion('飯物'),
     parseRegion('一品物'),
   ]);
   // 总耗时 ≈ 单次识别耗时（而不是 4x）
   ```

#### 实施成本

- **开发成本**：⭐⭐ 中等（需要实现切分逻辑）
- **API 成本**：❗ 4x（成本增加）
- **性能成本**：✅ 可并行，总耗时不增加
- **维护成本**：⭐⭐ 中等（需要维护区域坐标）

#### 预期收益

| 指标 | 旋转 | 旋转+切分 | 额外提升 |
|-----|------|-----------|---------|
| 价格列识别 | 4-6 个 | 4 个（每区域1个） | +100% |
| 列分组准确度 | 高 | 很高 | +30% |
| 整体准确率 | 30-50% | 60-80% | +2x |
| 分类标签 | 无 | 有 | ✅ |

#### 实施方案

##### 方案 A：手动定义区域（快速）

```typescript
// src/utils/menuRegions.ts
export const IZAKAYA_REGIONS = [
  { name: '串焼', x: 0, y: 0, width: 224, height: 1193 },
  { name: '揚物', x: 224, y: 0, width: 224, height: 1193 },
  { name: '飯物', x: 448, y: 0, width: 224, height: 1193 },
  { name: '一品物', x: 672, y: 0, width: 223, height: 1193 },
];
```

##### 方案 B：自动检测区域（智能）

```typescript
// 1. 先识别整张图片（找标题栏）
const titles = await detectTitleBlocks(imageBuffer);

// 2. 根据标题自动切分
const regions = autoSplitByTitles(titles);

// 3. 再次识别每个区域
const results = await parseRegions(regions);
```

**推荐**：先用方案 A 验证效果，再考虑方案 B

---

## 🎯 最终推荐方案

### 🥇 第一阶段：立即实施（成本：0）

```bash
# 1. 启用旋转
npm run parse:menu './菜单.png' -- --rotate
```

**预期**：
- ✅ 价格列识别率 ↑
- ✅ 整体准确率 +200-400%
- ✅ 零额外成本

**如果效果满意（准确率 > 40%）**：
→ 在生产环境默认启用旋转
→ 完成！🎉

---

### 🥈 第二阶段：按需实施（成本：4x API 调用）

**如果第一阶段准确率 < 40%，或需要更高精度**：

```typescript
// 实现区域切分
const regions = IZAKAYA_REGIONS;

for (const region of regions) {
  const regionBuffer = await extractRegion(rotatedImage, region);
  const items = await parseMenuImageToItems(regionBuffer);
  results.push({ category: region.name, items });
}
```

**预期**：
- ✅ 价格列识别率 100%
- ✅ 整体准确率 60-80%
- ⚠️ API 成本 × 4

---

## 📊 成本效益分析

### 场景对比

| 方案 | API 调用 | 开发成本 | 准确率 | 性价比 |
|-----|---------|---------|--------|--------|
| 当前（无优化） | 1x | 已完成 | ~10% | ⭐ |
| 仅旋转 | 1x | ✅ 已完成 | 30-50% | ⭐⭐⭐⭐⭐ |
| 旋转+切分 | 4x | 待实现 | 60-80% | ⭐⭐⭐⭐ |
| 旋转+智能切分 | 2x | 待实现 | 60-80% | ⭐⭐⭐⭐⭐ |

### 我的建议

#### 对于你的项目：

1. **立即做**：启用旋转
   - 成本：0
   - 收益：准确率 +3-5x
   - 实施：1 分钟（参数 `--rotate`）

2. **观察结果**：
   - 如果准确率 > 40% → 满足需求，完成！
   - 如果准确率 < 40% → 进入第 3 步

3. **按需做**：区域切分
   - 成本：API × 4
   - 收益：准确率再 +2x
   - 实施：1-2 小时（手动定义区域）

4. **进阶做**：智能切分（可选）
   - 成本：API × 2（首次识别 + 区域识别）
   - 收益：全自动 + 高精度
   - 实施：半天（实现自动检测逻辑）

---

## 🚀 立即测试

### 快速对比脚本

我已经为你创建了：
```bash
./快速测试旋转.sh
```

这个脚本会：
1. 测试无旋转的结果（基准）
2. 测试启用旋转的结果
3. 自动对比统计数据

### 手动测试

```bash
# 测试 A：基准
npm run parse:menu './截图 2025-11-02 12-48-38.png'
cp menu-output.json menu-output-baseline.json

# 测试 B：启用旋转
npm run parse:menu './截图 2025-11-02 12-48-38.png' -- --rotate
cp menu-output.json menu-output-rotate.json

# 对比结果
jq '[.[] | select(.price != null)] | length' menu-output-baseline.json  # 当前：10
jq '[.[] | select(.price != null)] | length' menu-output-rotate.json    # 预期：30+
```

---

## 💡 额外优化建议

### 如果实施区域切分，还可以：

1. **添加分类标签**：
   ```json
   {
     "category": "串焼",
     "name": "豚ばら",
     "price": 170
   }
   ```

2. **优化前端展示**：
   ```tsx
   <MenuSection title="串焼">
     {items.map(item => <MenuItem {...item} />)}
   </MenuSection>
   ```

3. **支持多种菜单布局**：
   ```typescript
   const layouts = {
     'izakaya_standard': IZAKAYA_REGIONS,
     'ramen_shop': RAMEN_REGIONS,
     // ...
   };
   ```

---

## 🎉 总结

### 你的两个建议都非常棒！

#### 旋转策略：⭐⭐⭐⭐⭐
- **必须做**
- **零成本**
- **效果显著**（准确率 +3-5x）
- **已实现，随时可用**

#### 区域切分：⭐⭐⭐⭐
- **推荐做**
- **有成本**（API × 区域数）
- **效果更好**（准确率再 +2x）
- **根据旋转效果决定是否实施**

### 行动计划

```bash
# Step 1：立即测试旋转效果
npm run parse:menu './截图 2025-11-02 12-48-38.png' -- --rotate

# Step 2：查看结果
cat menu-output.json | jq '[.[] | select(.price != null)] | .[0:10]'

# Step 3：根据效果决定
# - 满意 → 完成！🎉
# - 不满意 → 实施区域切分
```

**现在就测试看看效果吧！** 🚀


