# 功能特性说明

## 🎯 核心功能详解

### 1. 菜单去重机制 ⭐

**问题背景**：多人点单时，同一道菜可能被不同人录入，容易造成价格不一致。

**解决方案**：
- 使用 `(菜名, 价格)` 作为唯一键
- 智能检测冲突并提示用户

**使用场景**：
```
小明录入：かしわ ¥198
小红录入：かしわ ¥180  → 系统提示价格不同，请确认
```

**用户可选择**：
1. 使用现有价格 ¥198
2. 更新为新价格 ¥180

**代码位置**：`src/utils/menu.ts`

**关键函数**：
```typescript
// 检查菜单冲突
checkMenuConflict(existingMenu, newItem)

// 插入或更新菜单项
upsertMenuItem(menu, newItem, userId)

// 强制更新价格
forceUpdateMenuItemPrice(menu, nameDisplay, newPrice, userId)
```

### 2. 多轮点单机制 ⭐

**业务场景**：
- 第一轮：开始时点一些菜
- 等吃得差不多了，再点第二轮
- 第三轮加点...
- 每轮都要给店家看合并清单

**轮次状态**：
- `open`: 进行中，可以点单
- `closed`: 已关闭，不可再点单

**权限控制**：
- 只有 Owner 可以关闭当前轮
- 只有 Owner 可以开启新轮
- 同时只能有一个 open 的轮次

**实现细节**：
```typescript
// 轮次数据结构
interface Round {
  id: string;           // R1, R2, R3...
  groupId: string;
  status: 'open' | 'closed';
  createdBy: string;
  createdAt: string;
  closedAt?: string;
}
```

**使用流程**：
1. 创建组时自动开启 R1
2. 成员在 R1 点单
3. Owner 关闭 R1 → 生成本轮合并清单
4. Owner 开启 R2
5. 继续点单...

### 3. 角色权限系统 ⭐

**角色定义**：

#### Owner（桌主）
- 创建组的人
- 权限：
  - ✅ 开启/关闭轮次
  - ✅ 确认结账
  - ✅ 查看所有人的订单
  - ✅ 删除任何人的订单
  - ✅ 访问管理员视图
  - ✅ 导出整桌账单

#### 普通成员
- 加入组的人
- 权限：
  - ✅ 点单
  - ✅ 查看自己的订单
  - ✅ 删除自己当前轮的订单
  - ✅ 查看自己的账单
  - ❌ 不能开启/关闭轮次
  - ❌ 不能结账
  - ❌ 不能查看别人的订单

**实现细节**：
```typescript
// 权限检查
const isOwner = currentUser?.id === currentGroup?.ownerId;

// Owner 独有功能
{isOwner && (
  <button onClick={closeRound}>关闭轮次</button>
)}
```

### 4. 按人汇总账单

**功能说明**：
- 每个人可以查看自己点了什么
- 按轮次分组显示
- 自动计算个人总金额

**我的账单页面显示**：
```
━━━━━━━━━━━━━━━━
💰 小明 的账单
━━━━━━━━━━━━━━━━

【第1轮】
かしわ (鸡肉串) ¥198 × 2 = ¥396
かわ (鸡皮串) ¥165 × 1 = ¥165
轮次小计: ¥561

【第2轮】
手羽先 (鸡翅) ¥198 × 1 = ¥198
轮次小计: ¥198

━━━━━━━━━━━━━━━━
总计: ¥759
━━━━━━━━━━━━━━━━
```

### 5. Owner 汇总视图

**功能**：
- 整桌总览（轮次数、菜品数、总金额）
- 成员消费排行
- 轮次明细（可展开/收起）
- 全部菜品汇总
- 一键导出文本

**显示内容**：

#### 整桌总览
```
3 轮次  |  12 菜品数  |  ¥2,358 总金额
```

#### 成员消费
```
小明    (4 项)    ¥759
小红    (3 项)    ¥693
小李    (5 项)    ¥906
```

#### 轮次明细
```
▼ R1 [已关闭]                 ¥954
  かしわ (鸡肉串) ¥198 × 3
  かわ (鸡皮串) ¥165 × 2
```

#### 导出文本
- 点击"导出全部文本"按钮
- 自动复制到剪贴板
- 可直接粘贴到微信群

### 6. 实时数据同步

**当前实现**：Mock 数据（内存存储）

**后续可扩展**：
- Supabase Realtime
- Firebase Firestore
- WebSocket

**同步场景**：
- A 点了一道菜 → B 的菜单立即更新
- Owner 关闭轮次 → 所有人看到状态变化
- Owner 结账 → 所有人界面锁定

### 7. 移动端优化

**布局特点**：
- 移动优先设计
- 手指友好的按钮大小（最小 44x44px）
- 下拉刷新支持
- 底部安全区域适配（iPhone X）

**输入优化**：
- 数字输入自动弹出数字键盘
- 防止 iOS 自动缩放（font-size: 16px）
- 快速增减数量按钮

**性能优化**：
- 虚拟滚动（长列表）
- 图片懒加载
- 代码分割

### 8. PWA 支持

**功能**：
- 添加到主屏幕
- 离线缓存（Service Worker）
- 应用图标
- 全屏显示

**用户体验**：
1. 用户访问网站
2. 浏览器提示"添加到主屏幕"
3. 点击后像原生 App 一样使用
4. 无网络时也能查看已缓存的数据

**iOS 支持**：
- 自定义图标
- 状态栏样式
- 启动画面

### 9. 数据生命周期

**保留策略**：
- 组数据保留 7 天
- 7 天后自动清理
- 结账后数据仍保留到过期

**实现**：
```typescript
interface Group {
  createdAt: string;
  expiresAt: string;  // createdAt + 7天
  // ...
}
```

**清理机制**：
- 前端：不显示过期的组
- 后端：定时任务清理过期数据

### 10. 错误处理和用户提示

**菜单冲突**：
```
此菜已由「小明」录入，价格为 ¥198，
与您输入的 ¥180 不同。
请确认后选择：
1. 使用现有价格
2. 更新为新价格
```

**权限不足**：
```
只有管理员可以关闭轮次
```

**轮次已关闭**：
```
该轮次已关闭，无法添加订单
```

**结账后**：
```
该桌已结账，无法加入
```

## 🎨 UI/UX 亮点

### 1. 渐变背景
- 首页使用品牌色渐变
- 顶部状态栏使用主题色
- 总金额卡片使用渐变效果

### 2. 状态指示
- 轮次状态徽章（进行中/已关闭）
- 结账状态提示
- 加载状态动画

### 3. 交互反馈
- 按钮点击效果
- 列表项悬浮效果
- 复制成功提示

### 4. 信息层级
- 重要信息突出显示（大字体、高对比度）
- 次要信息灰色显示
- 备注信息小字体

## 🔧 技术亮点

### 1. TypeScript 类型安全
- 所有数据都有类型定义
- 编译时检查错误
- IDE 自动提示

### 2. Zustand 状态管理
- 轻量级（1KB）
- 简单易用
- 无需 Provider

### 3. Tailwind CSS
- 实用优先的 CSS
- 快速开发
- 响应式设计

### 4. 代码组织
- 清晰的目录结构
- 单一职责原则
- 易于维护和扩展

## 📊 性能指标

**目标**：
- First Contentful Paint (FCP) < 1.5s
- Largest Contentful Paint (LCP) < 2.5s
- Time to Interactive (TTI) < 3.5s
- Lighthouse Score > 90

**优化措施**：
- 代码分割
- 懒加载
- 图片优化
- CDN 加速

## 🚀 后续功能规划

### v1.1
- [ ] 历史菜单（跨桌复用常点的菜）
- [ ] 二维码分享桌号
- [ ] 菜品收藏
- [ ] 快速点"上次的"

### v1.2
- [ ] 拍照识别菜单（OCR）
- [ ] 某人请客功能
- [ ] 优惠券/折扣
- [ ] 小费计算

### v2.0
- [ ] Flutter/React Native 版本
- [ ] 推送通知
- [ ] 云端同步
- [ ] 多语言支持

