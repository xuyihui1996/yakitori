# 🧪 菜单扫描功能 - 本地测试指南

## 快速测试（3 步）

### 步骤 1: 设置环境变量

在终端中设置（临时，当前会话有效）：

```bash
export GOOGLE_APPLICATION_CREDENTIALS=/home/kyo2/project/Ordered/yakitori-477003-94640fab8889.json
```

或者创建 `.env.local` 文件：

```bash
# 在项目根目录创建 .env.local
GOOGLE_APPLICATION_CREDENTIALS=/home/kyo2/project/Ordered/yakitori-477003-94640fab8889.json
```

### 步骤 2: 启动开发服务器

```bash
npm run dev
```

### 步骤 3: 测试扫描功能

1. 打开浏览器访问 `http://localhost:5173`
2. 创建或加入一个组
3. 点击"扫描菜单"按钮
4. 上传测试图片（如 `截图 2025-11-02 14-51-50.png`）
5. 查看识别结果！

---

## 🧪 命令行测试（推荐）

如果你想先测试 OCR 功能，不启动完整应用：

### 测试单张图片

```bash
npm run parse:menu "截图 2025-11-02 14-51-50.png"
```

结果会保存到 `menu-output.json`

### 测试多个区域（推荐！识别率更高）

```bash
npm run parse:regions "截图 2025-11-02 14-51-50.png" "截图 2025-11-02 14-53-28.png" "粘贴的图像.png"
```

结果会保存到 `menu-output-regions.json`

---

## 🔍 详细测试流程

### 1. 环境准备

```bash
# 1.1 确保依赖已安装
npm install

# 1.2 检查环境变量（应该看到 JSON 文件的内容）
cat $GOOGLE_APPLICATION_CREDENTIALS

# 如果为空，重新设置
export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/yakitori-477003-94640fab8889.json
```

### 2. 测试 OCR 功能（命令行）

```bash
# 测试单张图片
npm run parse:menu "截图 2025-11-02 14-51-50.png"

# 查看结果
cat menu-output.json | jq '.[] | select(.price != null)'
```

**预期结果**：
```json
[
  {
    "name": "唐扬げ",
    "price": 130,
    "rawText": "唐扬げ 一三〇円",
    "confidence": 0.9,
    "needsReview": false
  },
  ...
]
```

### 3. 测试完整应用

```bash
# 启动开发服务器
npm run dev
```

在浏览器中：
1. 访问 `http://localhost:5173`
2. 创建新组或加入组
3. 开启一个轮次
4. 点击**"扫描菜单"**按钮（绿色）
5. 选择"上传图片"
6. 选择测试图片
7. 点击"开始识别"
8. 等待 5-10 秒
9. 查看识别结果
10. 勾选菜品并点击"确认添加"

**预期结果**：
- ✅ 菜品成功添加到共享菜单
- ✅ 当前用户的订单自动添加 1 份
- ✅ 页面刷新显示新添加的菜品

---

## 🐛 常见问题

### Q: 提示 "GOOGLE_APPLICATION_CREDENTIALS not set"

**解决**：
```bash
# 检查环境变量
echo $GOOGLE_APPLICATION_CREDENTIALS

# 如果为空，重新设置
export GOOGLE_APPLICATION_CREDENTIALS=/home/kyo2/project/Ordered/yakitori-477003-94640fab8889.json

# 确认设置成功
echo $GOOGLE_APPLICATION_CREDENTIALS
```

### Q: npm run dev 后 API 调用失败

**原因**：Vite 开发服务器不支持 Vercel API 路由。

**解决方案 1**：使用 Vercel CLI（推荐）

```bash
# 安装 Vercel CLI
npm i -g vercel

# 使用 Vercel CLI 启动本地开发服务器
vercel dev
```

这会在 `http://localhost:3000` 启动一个完整的 Vercel 环境，支持 API 路由。

**解决方案 2**：使用命令行测试 OCR

先用 `npm run parse:menu` 测试 OCR 功能是否正常，前端部署后再测试完整流程。

### Q: 图片上传后无响应

**检查项**：
1. 打开浏览器控制台（F12），查看 Network 标签
2. 找到 `/api/parse-menu` 请求
3. 查看请求状态和响应

**常见错误**：
- `404`: API 路由不存在（需要用 `vercel dev`）
- `500`: OCR 处理失败（查看错误信息）
- `超时`: 图片太大或网络问题

---

## 📊 测试检查清单

### OCR 功能测试

- [ ] ✅ 环境变量已设置
- [ ] ✅ `npm run parse:menu` 命令成功
- [ ] ✅ 输出文件包含识别结果
- [ ] ✅ 价格正确解析（日文数字 → 阿拉伯数字）
- [ ] ✅ 识别率达到 50% 左右（区域切分）

### 前端集成测试

- [ ] ✅ "扫描菜单"按钮显示
- [ ] ✅ 可以选择/拍摄图片
- [ ] ✅ 图片预览正常
- [ ] ✅ "开始识别"按钮响应
- [ ] ✅ 加载动画显示
- [ ] ✅ 识别结果列表显示
- [ ] ✅ 可以编辑菜品
- [ ] ✅ 可以勾选/取消菜品
- [ ] ✅ "确认添加"按钮响应
- [ ] ✅ 菜品成功添加到菜单
- [ ] ✅ 订单自动创建

### API 集成测试（需要 vercel dev）

- [ ] ✅ POST /api/parse-menu 返回 200
- [ ] ✅ 返回数据格式正确
- [ ] ✅ 处理时间 < 30s
- [ ] ✅ 错误处理正常（无效图片、超大文件等）

---

## 🎯 推荐测试流程

### 方式 1: 纯 OCR 测试（无需启动服务器）

```bash
# 1. 设置环境变量
export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/yakitori-477003-94640fab8889.json

# 2. 测试区域切分（最佳效果）
npm run parse:regions "截图 2025-11-02 14-51-50.png" "截图 2025-11-02 14-53-28.png" "粘贴的图像.png"

# 3. 查看结果
cat menu-output-regions.json | jq '.[] | select(.needsReview == false) | {name, price}'

# 4. 统计识别率
echo "完美识别项数："
cat menu-output-regions.json | jq '.[] | select(.needsReview == false and .price != null)' | jq -s 'length'
echo "总项数："
cat menu-output-regions.json | jq -s 'length'
```

### 方式 2: 完整应用测试（推荐用于生产前验证）

```bash
# 1. 安装 Vercel CLI
npm i -g vercel

# 2. 启动 Vercel 开发服务器
vercel dev

# 3. 浏览器访问
# http://localhost:3000

# 4. 测试完整流程
```

### 方式 3: 前端开发测试（API 暂时跳过）

```bash
# 1. 启动 Vite 开发服务器
npm run dev

# 2. 测试前端 UI（除了 API 调用）
# - 按钮是否显示
# - 弹窗是否正常
# - 图片上传是否工作
# - UI 是否响应式

# 3. API 功能部署后再测试
```

---

## 💡 测试技巧

### 使用已有的测试结果

你已经有测试结果文件了！

```bash
# 查看完美识别的项
jq '.[] | select(.price != null and .needsReview == false)' menu-output-regions.json

# 查看需要审核的项
jq '.[] | select(.needsReview == true)' menu-output-regions.json

# 按价格排序
jq 'sort_by(.price) | .[]' menu-output-regions.json
```

### 模拟前端调用 API

如果你想测试 API 而不通过浏览器：

```bash
# 将图片转为 base64
base64 "截图 2025-11-02 14-51-50.png" > image.base64

# 调用本地 API（需要先启动 vercel dev）
curl -X POST http://localhost:3000/api/parse-menu \
  -H "Content-Type: application/json" \
  -d "{\"image\": \"$(cat image.base64)\"}" \
  | jq '.'
```

---

## 🚀 准备部署

本地测试通过后，就可以部署了！

```bash
# 1. 提交代码
git add .
git commit -m "feat: 添加菜单扫描功能"
git push origin main

# 2. Vercel 自动部署

# 3. 设置生产环境变量（Vercel Dashboard）
# GOOGLE_APPLICATION_CREDENTIALS = <JSON 内容>

# 4. 重新部署或等待自动部署完成
```

---

**祝测试顺利！🎉**

