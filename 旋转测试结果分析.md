# 旋转测试结果分析

## ❌ 测试结果：旋转效果不佳

### 数据对比

| 指标 | 无旋转（基准） | 旋转后 | 变化 |
|-----|--------------|--------|------|
| 总项数 | 104 | 78 | -25% |
| 有价格的项 | 55 | 51 | -7% |
| 不需审核的项 | 10 | 37 | **+270%** |
| ✅ **完美识别** | **10** | **37** | **+270%** |

### 识别质量对比

#### 无旋转（正确）✅
```
✅ チリソース春巻･･･ → ¥350
✅ ゲソの唐揚げ → ¥600
✅ さつまスティック → ¥350
✅ 揚げぎんなん → ¥250
✅ 山芋スライス → ¥300
```

#### 旋转后（错误）❌
```
❌ 円円円円円円円 → ¥54541  （完全错误）
❌ 〇〇〇〇六二 → ¥2
❌ 〇〇〇〇〇五 → ¥713116
❌ コロッケ → ¥43534
❌ サツマバタージャガバター → ¥353535355
```

---

## 🔍 问题根因分析

### 核心问题

旋转后，Vision API 把**整列的价格识别成一个横排的长数字**。

#### 原图布局（无旋转）
```
竖排菜单：
  菜名    价格
  ↓       ↓
  豚ばら  一
          二
          〇
          円
```

Vision 识别：理解这是竖排，每个 word 独立
- ✅ "豚ばら"
- ✅ "一二〇円"（合并后）

#### 旋转 90° 后
```
横排变成：
  → 豚ばら 一 二 〇 円 かしわ 二 五 〇 円 ...
```

Vision 识别：认为这是横排，把所有数字连起来
- ❌ "円円円円円円円" (所有円连在一起)
- ❌ "54541" (所有数字连在一起)

---

## 💡 为什么会这样？

### 1. 旋转破坏了原有的布局理解

**Vision API 的智能之处**：
- 即使图片是横向的，Vision 也能识别出这是"竖排布局"
- 返回的 words 已经按照竖排的逻辑分组了

**旋转的副作用**：
- 旋转 90° 后，竖排变横排
- Vision 认为这是一个横排的长句子
- 把所有内容连起来了

### 2. 我们的假设错误

**我们的假设**：
- 横向图片 = Vision 会识别错
- 旋转成竖向 = Vision 会识别对

**实际情况**：
- Vision 已经正确理解了竖排布局（即使图片是横向的）
- 旋转反而破坏了这个理解

---

## 📊 列分组对比

### 无旋转（较好）
```
📏 页面宽度: 1193px, 列间距阈值: 36px
📋 列 0: 11 个 words
📋 列 1: 14 个 words
📋 列 2: 11 个 words
...
```

每列都有 10+ 个 words，说明分组合理。

### 旋转后（变差）
```
📏 页面宽度: 830px, 列间距阈值: 25px
📋 列 2: 1 个 words  ⚠️ 太少
📋 列 5: 4 个 words  ⚠️ 太少
📋 列 6: 4 个 words  ⚠️ 太少
📋 列 11: 1 个 words ⚠️ 太少
...
```

很多列只有 1-4 个 words，说明：
- 列分得过细
- 或者识别结果本身就乱了

---

## ✅ 结论

### ❌ 不要旋转图片

**原因**：
1. Vision API 已经能正确识别竖排布局（即使图片是横向的）
2. 旋转反而破坏了这个识别
3. 旋转后的结果质量更差

### ✅ 保持当前方案

当前的无旋转方案已经能够：
- ✅ 正确识别菜名和价格
- ✅ 10 个完美识别的项
- ✅ 55 个有价格的项

虽然有 94 个需要审核，但质量是对的。

---

## 🎯 下一步优化方向

既然旋转不work，我们应该：

### 1. 优化列分类算法（优先）

**当前问题**：价格列识别为 0 个

**原因**：
```typescript
// columnClassifier.ts
function classifyColumn(blocks: OcrBlock[]): ColumnType {
  const ratio = priceLike / blocks.length;
  return ratio > 0.6 ? 'price' : 'name';  // 阈值可能太高
}
```

**解决方案**：
- 降低阈值：0.6 → 0.4
- 或者使用更智能的判断逻辑

### 2. 调整列分组阈值

**当前**：
```typescript
const gapThreshold = pageWidth * 0.03; // 3%
```

**问题**：可能太小，导致同一列被分成多列

**解决方案**：
- 尝试 4-5%
- 或者使用自适应阈值

### 3. 区域切分（最有效）

**原理**：
- 把整张菜单切成 4 块
- 每块单独识别
- 每块只有 2-3 列，更容易分类

**预期**：
- 价格列识别率 100%
- 整体准确率 60-80%

### 4. 改进合并策略

**当前问题**：
- 有些菜名和价格已经合并在一起了（"チリソース春巻･･･三五〇円"）
- 但有些没有

**解决方案**：
- 调整 `verticalMerger.ts` 的距离阈值
- 让更多的菜名和价格合并

---

## 📝 测试记录

### Test A - 无旋转 ✅
```bash
npm run parse:menu './截图 2025-11-02 12-48-38.png'
```

**结果**：
- 完美识别：10 项
- 识别质量：优秀
- 价格准确：✅

### Test B - 旋转 90° ❌
```bash
npm run parse:menu './截图 2025-11-02 12-48-38.png' -- --rotate
```

**结果**：
- 完美识别：37 项（但都是错的）
- 识别质量：极差
- 价格准确：❌（全是乱码）

### Test C - 旋转 -90° （待测试）
```bash
# 改成逆时针旋转后测试
```

**预期**：可能也不会好

---

## 🎉 最终建议

### ❌ 不要使用旋转

理由：
1. Vision API 已经能正确理解竖排布局
2. 旋转破坏了这个理解
3. 结果质量变差

### ✅ 优先实施

1. **立即**：调整列分类阈值
   - 从 0.6 → 0.4
   - 让价格列能被识别出来

2. **然后**：实施区域切分
   - 4 个区域，每个 2-3 列
   - 价格列识别率 100%

3. **最后**：优化合并策略
   - 让更多菜名和价格合并
   - 减少需要审核的项

---

## 💡 关键教训

**不要盲目优化**：
- 我们假设"旋转图片会更好"
- 但实际测试证明相反
- **总是先测试，再下结论**

**相信 Vision API**：
- Vision API 比我们想象的更智能
- 它已经能识别竖排布局（即使图片是横向的）
- 不需要我们"帮助"它

**聚焦真正的问题**：
- 当前的真正问题：列分类失败（0 个价格列）
- 而不是图片方向问题
- **优化要对症下药**


