# 菜单图片解析服务 - 完整说明

## 📋 概述

已实现完整的菜单图片解析服务，支持识别日本居酒屋菜单照片并提取菜品名称和价格。

## 📁 文件结构

```
src/
├── types/
│   └── ocr.ts                    # OCR 类型定义
├── ocr/
│   └── googleVision.ts           # Google Vision API 集成
└── parser/
    ├── index.ts                  # 主入口函数
    ├── layout.ts                 # 版面解析
    ├── columnGrouping.ts         # 按列分组算法
    ├── lineToMenuItem.ts         # 行文本解析（菜名+价格）
    ├── example.ts                # 使用示例
    ├── __tests__/
    │   └── lineToMenuItem.test.ts # 单元测试
    ├── README.md                 # 使用文档
    └── INSTALLATION.md           # 安装指南
```

## 🚀 快速开始

### 1. 安装依赖

```bash
npm install @google-cloud/vision
```

### 2. 配置 Google Cloud 凭据

```bash
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/key.json
```

详细步骤见：`src/parser/INSTALLATION.md`

### 3. 使用示例

```typescript
import { parseMenuImageToItems } from './src/parser';

// 从 Buffer 读取
const items = await parseMenuImageToItems(
  { type: 'buffer', data: imageBuffer },
  { languageHints: ['ja'], maxColumns: 4 }
);

// 从 URL 读取
const items = await parseMenuImageToItems(
  { type: 'url', data: 'https://example.com/menu.jpg' }
);
```

## 🎯 核心功能

### 1. OCR 调用
- ✅ 支持 Google Cloud Vision API
- ✅ 使用 DOCUMENT_TEXT_DETECTION 模式（支持版面结构）
- ✅ 语言提示：`['ja']`
- ✅ 可扩展架构，支持接入 Azure / AWS / PaddleOCR

### 2. 版面解析
- ✅ 将 OCR 结果转换为统一的内部结构
- ✅ 提取块（block）、词（word）及其位置信息
- ✅ 保持边界框（bounding box）信息

### 3. 按列分组
- ✅ 智能识别竖排菜单的多列结构
- ✅ 基于 x 中心点的聚类算法
- ✅ 可配置的列间距阈值（`maxColumnGap`）
- ✅ 按列号排序输出

### 4. 行文本解析
- ✅ 自动提取价格（支持多种格式）
- ✅ 提取菜名（去掉价格部分）
- ✅ 计算置信度
- ✅ 标记需要人工审核的行

### 5. 价格格式支持
- ✅ `450円` - 普通阿拉伯数字
- ✅ `４５0円` - 全角+半角混合
- ✅ `三五〇円` - 日式汉数字
- ✅ `500` - 没有"円"
- ✅ `５００` - 全角数字

## 📊 输出格式

```typescript
interface DetectedMenuItem {
  name: string;              // 菜名（已去掉价格）
  price?: number;            // 价格（日元），整数
  rawText: string;           // 原始文本行
  bbox?: {                   // 位置坐标
    x: number;
    y: number;
    width: number;
    height: number;
  };
  sourceColumn?: number;     // 所属列号（从0开始）
  confidence?: number;        // 置信度 0~1
  needsReview: boolean;       // 是否需要人工审核
}
```

输出按照**列 → 行**排序，`needsReview: true` 的项放在最后。

## 🔧 参数调整

### 列分组阈值

如果识别结果不准确，可以调整 `maxColumnGap`：

```typescript
// 菜单列数少（2-3列），增大阈值
const items = await parseMenuImageToItems(input, {
  maxColumnGap: 10,  // 10%
});

// 菜单列数多（4-6列），减小阈值
const items = await parseMenuImageToItems(input, {
  maxColumnGap: 5,   // 5%
});
```

### 最大列数

限制识别的最大列数：

```typescript
const items = await parseMenuImageToItems(input, {
  maxColumns: 4,
});
```

## 🧪 测试

运行单元测试（需要配置测试框架）：

```bash
# 测试行解析功能
npm test -- lineToMenuItem.test.ts
```

测试用例覆盖：
- 普通价格格式
- 全角数字
- 汉数字价格
- 无价格的情况
- 边界情况

## 📝 使用流程

### 完整流程

```
1. 用户上传菜单图片
   ↓
2. 调用 parseMenuImageToItems()
   ↓
3. OCR（Google Vision API）
   ↓
4. 规范化 OCR 结果
   ↓
5. 按列分组
   ↓
6. 逐行解析（菜名+价格）
   ↓
7. 输出结构化结果
   ↓
8. 前端展示，用户确认
   ↓
9. 写入共享菜单
```

### 前端集成示例

```typescript
// 在前端调用（需要先通过 API 后端）
async function uploadMenuImage(file: File) {
  const formData = new FormData();
  formData.append('image', file);

  const response = await fetch('/api/parse-menu', {
    method: 'POST',
    body: formData,
  });

  const items: DetectedMenuItem[] = await response.json();

  // 展示识别结果
  items.forEach(item => {
    if (item.needsReview) {
      // 标记为需要审核，让用户确认/补价格
      showReviewItem(item);
    } else {
      // 直接展示，用户确认后添加
      showMenuItem(item);
    }
  });
}
```

## 🔌 扩展其他 OCR 服务

### 接入 Azure Computer Vision

1. 在 `src/ocr/` 下创建 `azureVision.ts`
2. 实现类似的 `runOcrOnImage()` 函数
3. 在 `parser/index.ts` 中添加对 Azure 的支持

### 接入 AWS Textract

1. 在 `src/ocr/` 下创建 `awsTextract.ts`
2. 实现对应的解析函数

### 接入 PaddleOCR

1. 安装 PaddleOCR（Python）
2. 创建 Node.js 包装器
3. 在 `src/ocr/` 下创建 `paddleOcr.ts`

详细扩展方式见各文件的注释。

## ⚙️ 配置选项

```typescript
interface ParseMenuOptions {
  languageHints?: string[];   // 默认 ['ja']
  maxColumns?: number;         // 默认 10
  maxColumnGap?: number;       // 默认 8（页面宽度的百分比）
  pricePatterns?: string[];    // 自定义价格正则（备用）
}
```

## 🐛 错误处理

### 常见错误

1. **OCR 调用失败**
   - 检查 Google Cloud 凭据配置
   - 检查 Vision API 是否启用
   - 检查网络连接

2. **识别结果不准确**
   - 调整 `maxColumnGap` 参数
   - 检查图片质量（清晰度、反光）
   - 使用更高分辨率的图片

3. **价格识别不出来**
   - 检查 `rawText` 查看原始识别文本
   - 如果价格格式特殊，扩展 `lineToMenuItem.ts` 的正则
   - 标记为 `needsReview: true`，让用户手动确认

## 📚 相关文档

- `src/parser/README.md` - 详细使用文档
- `src/parser/INSTALLATION.md` - 安装和配置指南
- `src/parser/example.ts` - 代码示例
- `src/parser/__tests__/lineToMenuItem.test.ts` - 测试用例

## 🔮 后续优化方向

- [ ] 支持图片自动旋转检测
- [ ] 添加图片预处理（去反光、增强对比度）
- [ ] 支持更多价格格式（如"1,200円"）
- [ ] 支持批量处理多张图片
- [ ] 添加缓存机制，避免重复 OCR
- [ ] 前端直接调用（通过 WebAssembly）

## 📞 问题反馈

如遇问题，请检查：
1. Google Cloud 凭据是否正确配置
2. Vision API 是否已启用
3. 图片质量和格式是否符合要求
4. 参数是否需要调整

---

**项目状态**: ✅ 完成，可直接使用  
**测试状态**: ✅ 单元测试已包含  
**文档状态**: ✅ 完整文档已提供



