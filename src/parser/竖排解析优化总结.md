# 竖排菜单解析优化总结

## 🎯 核心问题分析

### 问题 1：使用了错误的粒度级别

**之前的做法**：
```typescript
// 使用 Block 级别（太粗糙！）
Page → Block (包含整片区域的文字)
```

**问题**：
- Block 会把多个价格合并："一一 〇 円 一二 〇 円 二五 〇 円"
- 无法精确定位每个菜名和价格

**正确做法**：
```typescript
// 使用 Word 级别（正确粒度！）
Page → Block → Paragraph → Word (单个竖排单元)
```

**改进**：创建了 `layoutV2.ts`，提取 576 个独立的 words

---

### 问题 2：单字符被噪音过滤器全部过滤

**之前的做法**：
```typescript
// noiseFilter.ts
if (t.length === 1) return true; // ❌ 把 "円"、"〇" 都过滤了！
```

**问题**：
- 竖排菜单中，"一"、"二"、"〇"、"円" 都是单独的 word
- 全部被过滤，导致价格丢失

**正确做法**：
```typescript
// 先合并竖排的相邻 words，再过滤
mergeVerticalWords() // "一" + "二" + "〇" + "円" → "一二〇円"
```

**改进**：创建了 `verticalMerger.ts`，将 576 words → 190 items

---

### 问题 3：日文数字转换算法有bug

**之前的做法**：
```typescript
if (digit < 10) {
  current = digit; // ❌ 直接覆盖，不是累加！
}
// "三五〇" → current = 3 → 5 → 0，返回 0
```

**正确做法**：
```typescript
// 逐位转换模式
"三五〇" → "3" + "5" + "0" → "350" → 350
```

**改进**：修复了 `lineToMenuItem.ts` 中的 `convertKansujiToNumber()` 函数

---

## ✅ 最终效果

### 识别结果示例

| 原始文本 | 菜名 | 价格 | 状态 |
|---------|-----|------|------|
| `チリソース春巻･･･三五〇円` | チリソース春巻･･･ | ¥350 | ✅ |
| `ゲソの唐揚げ・・・・・・・六〇〇円` | ゲソの唐揚げ・・・・・・・ | ¥600 | ✅ |
| `揚げぎんなん...二五〇円` | 揚げぎんなん... | ¥250 | ✅ |
| `一二〇円` | - | ¥120 | ⚠️ needsReview |

### 统计

```
📊 提取了 576 个 words
🔗 竖排合并: 576 words → 190 items
✅ 可用的项: 10+
⚠️  需要审核的项: 94
📊 总计: 104
```

---

## 🚀 核心改进

### 1. Word 级别解析（`layoutV2.ts`）

```typescript
export function normalizeGoogleVisionResponseV2(response) {
  // 直接提取所有 words，而不是 blocks
  for (const word of paragraph.words) {
    wordBlocks.push({
      text: wordText.trim(),
      bbox: wordBbox,
      confidence: avgConfidence,
    });
  }
}
```

### 2. 竖排合并（`verticalMerger.ts`）

```typescript
export function mergeVerticalWords(blocks) {
  // 算法：
  // 1. 如果两个 word 在同一竖列（X 距离 < 15px）
  // 2. 且在 Y 方向上相邻（Y 间距 < 15px）
  // 3. 则合并它们
  
  // "一" + "二" + "〇" + "円" → "一二〇円"
}
```

### 3. 日文数字转换（`lineToMenuItem.ts`）

```typescript
function convertKansujiToNumber(kansuji) {
  // 逐位转换模式（没有单位"十/百/千"）
  if (!hasUnit) {
    "三五〇" → "3" + "5" + "0" → "350"
  }
  
  // 带单位模式（有"十/百/千"）
  "三百五十" → 350
}
```

### 4. 优化的列分组（`columnGroupingV2.ts`）

```typescript
export function groupWordsIntoColumns(blocks) {
  // 使用更小的列间距阈值（3% 而不是 8%）
  const gapThreshold = pageWidth * 0.03;
}
```

---

## 📊 性能对比

| 指标 | 旧版本（Block级别） | 新版本（Word级别） |
|-----|------------------|------------------|
| 识别单元数 | ~40 blocks | 576 words → 190 items |
| 价格识别率 | 0% | ~10% (会继续提升) |
| 菜名识别 | 多个合并 | 精确分离 |
| 处理时间 | ~1000ms | ~986ms |

---

## 🎯 下一步优化方向

### 1. 改进列分类
当前问题：识别出 10 个 name columns 和 **0 个 price columns**

原因：每列的 words 太少（10-18 个），列分类器无法准确判断

**解决方案**：
- 调整 `columnClassifier.ts` 的判断逻辑
- 或者不区分 name/price 列，直接用 Y 坐标匹配

### 2. 优化合并策略
当前问题：有些菜名和价格在同一行，有些分开

**解决方案**：
- 识别文本方向（竖排 vs 横排）
- 对于真正的竖排菜单，应该把菜名列和价格列分开匹配

### 3. 提高准确率
当前：10 个完全正确 + 94 个需要审核

**目标**：让更多的项不需要审核

---

## 🔍 关键文件

| 文件 | 作用 | 关键改进 |
|-----|-----|---------|
| `layoutV2.ts` | Word 级别解析 | 提取 576 个 words |
| `verticalMerger.ts` | 竖排合并 | 合并相邻 words |
| `columnGroupingV2.ts` | 列分组 | 更小的阈值 |
| `lineToMenuItem.ts` | 价格识别 | 修复日文数字转换 |
| `price.ts` | 价格解析 | 支持竖排格式 |

---

## 💡 核心经验

1. **选择正确的粒度**：Word 级别而不是 Block 级别
2. **先合并再过滤**：避免单字符被过滤掉
3. **理解 Vision API 的层次结构**：Page → Block → Paragraph → Word → Symbol
4. **针对竖排优化算法**：Y 坐标相邻性判断
5. **逐步调试**：从 OCR 原始输出开始，逐步验证每个处理步骤

---

## 🎉 成功案例

```json
[
  {
    "name": "チリソース春巻･･･",
    "price": 350,
    "rawText": "チリソース春巻･･･三五〇円",
    "needsReview": false
  },
  {
    "name": "ゲソの唐揚げ・・・・・・・",
    "price": 600,
    "rawText": "ゲソの唐揚げ・・・・・・・六〇〇円",
    "needsReview": false
  },
  {
    "name": "揚げぎんなん...",
    "price": 250,
    "rawText": "揚げぎんなん...二五〇円",
    "needsReview": false
  }
]
```

**完美！** 🎯


