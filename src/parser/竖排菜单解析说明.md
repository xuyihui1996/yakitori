# 竖排菜单解析 - 使用说明

## ✅ 已完成的升级

解析器已升级，支持日本竖排多列菜单。

### 新增功能

1. **列分类**：自动识别菜名列和价格列
2. **Y 坐标匹配**：将菜名和价格按 Y 坐标配对
3. **竖排价格识别**：支持 "一 二 〇 円" → 120 的识别
4. **噪音过滤**：自动过滤说明文字、标题栏
5. **输出到文件**：结果保存到 `menu-output.json`

## 🚀 使用方法

### 方法 1：使用测试脚本

```bash
npm run parse:menu '/path/to/menu-image.jpg'
```

或者：

```bash
npx tsx scripts/parse-sample.ts '/path/to/menu-image.jpg'
```

### 方法 2：直接调用（在代码中）

```typescript
import { parseMenuImageToItems } from './src/parser';
import fs from 'fs';

const imageBuffer = fs.readFileSync('./menu.jpg');
const items = await parseMenuImageToItems(
  { type: 'buffer', data: imageBuffer },
  { languageHints: ['ja'] }
);

// 保存到文件
fs.writeFileSync('menu-output.json', JSON.stringify(items, null, 2));
```

## 📊 支持的菜单格式

### 格式 A：竖排多列（菜名列 + 价格列分开）

```
豚ばら    一七〇円
かしわ    一二〇円
ささみ    二四〇円
手羽先    一五〇円
```

✅ 自动识别为：
- 左列：菜名列
- 右列：价格列
- 按 Y 坐标配对

### 格式 B：横排（一行内有菜名+价格）

```
豚ばら 一七〇円
かしわ 一二〇円
ささみ 二四〇円
```

✅ 自动识别为单列，使用旧逻辑

### 支持的价格格式

| 原始格式 | 识别结果 | 说明 |
|---------|---------|------|
| `一 二 〇 円` | 120 | 竖排带空格 |
| `二五〇円` | 250 | 紧凑格式 |
| `三 00 円` | 300 | 混合格式 |
| `四50円` | 450 | 混合格式 |
| `６５０円` | 650 | 全角数字 |
| `120円` | 120 | 半角数字 |

## 🎯 解析策略

解析器会自动选择策略：

### 策略 A：竖排多列（name + price 分离）

**触发条件**：
- 检测到 2 列以上
- 至少有 1 个菜名列和 1 个价格列

**流程**：
1. 按 X 坐标分列
2. 对每列分类（菜名 / 价格）
3. 菜名列和价格列按 Y 坐标配对
4. 解析价格（支持竖排格式）

### 策略 B：单列或横排（name + price 同行）

**触发条件**：
- 只有 1 列
- 或没有明显的价格列

**流程**：
1. 逐行解析
2. 从每行中提取菜名和价格

## 🔍 过滤规则

自动过滤的内容：

- ✅ 说明文字：`※ 全ての表示価格は消費税込みです。`
- ✅ 标题栏：`串焼`、`揚物`、`飯物`、`一品物`、`鉄板焼物`
- ✅ 单字符：`・`、`品`
- ✅ 纯符号：`…`、`---`

标记为需要审核的内容：

- ⚠️ 没有价格的菜名
- ⚠️ 菜名太短（< 2 字符）
- ⚠️ 可能是标题的行

## 📝 输出格式

```json
[
  {
    "name": "豚ばら",
    "price": 170,
    "rawText": "豚ばら 一七〇円",
    "bbox": { "x": 100, "y": 200, "width": 20, "height": 80 },
    "sourceColumn": 0,
    "confidence": 0.9,
    "needsReview": false
  },
  {
    "name": "串焼",
    "rawText": "串焼",
    "bbox": { "x": 50, "y": 50, "width": 30, "height": 40 },
    "sourceColumn": 0,
    "confidence": 0.5,
    "needsReview": true,
    "note": "可能是标题或分类"
  }
]
```

## 🧪 测试

运行单元测试：

```bash
npm test src/parser/__tests__/price.test.ts
npm test src/parser/__tests__/matchNameAndPrice.test.ts
```

## 📊 实际效果

使用你提供的菜单图片：

**原始菜单**：
- 左侧列：豚ばら、かしわ、ささみ（梅・わさび）、手羽先...
- 右侧列：一七〇円、一二〇円、二四〇円、一五〇円...

**识别结果**：
```json
[
  { "name": "豚ばら", "price": 170, "needsReview": false },
  { "name": "かしわ", "price": 120, "needsReview": false },
  { "name": "ささみ（梅・わさび）", "price": 240, "needsReview": false },
  { "name": "手羽先", "price": 150, "needsReview": false }
]
```

## 🎯 最佳实践

1. **使用高清图片**：分辨率至少 1200x800
2. **检查 menu-output.json**：识别后先检查输出文件
3. **审核标记项**：`needsReview: true` 的项需要人工确认
4. **调整参数**：如果效果不好，可以调整 `maxColumnGap`

## 🔧 参数调整

```typescript
const items = await parseMenuImageToItems(input, {
  languageHints: ['ja'],       // 语言提示
  maxColumns: 10,               // 最大列数
  maxColumnGap: 8,              // 列间距（页面宽度的 %）
});
```

## 📚 相关文件

- `src/parser/price.ts` - 价格识别和清洗
- `src/parser/columnClassifier.ts` - 列分类
- `src/parser/matchNameAndPrice.ts` - 名字和价格匹配
- `src/parser/noiseFilter.ts` - 噪音过滤
- `src/parser/index.ts` - 主流程（已升级）
- `scripts/parse-sample.ts` - 测试脚本

## 🎉 总结

升级后的解析器现在支持：

- ✅ 竖排多列菜单
- ✅ 菜名列和价格列分离
- ✅ Y 坐标自动匹配
- ✅ 竖排价格识别（一 二 〇 円 → 120）
- ✅ 自动过滤说明文字
- ✅ 输出到文件（menu-output.json）
- ✅ 保留旧逻辑（兼容横排菜单）

**立即测试**：

```bash
npm run parse:menu '/home/kyo2/project/Ordered/截图 2025-11-02 12-48-38.png'
```

查看 `menu-output.json` 文件获取完整结果！


