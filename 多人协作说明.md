# ⚠️ 多人协作重要说明

## 🔴 当前限制

### ❌ Mock 数据的局限性

当前版本使用的是 **内存存储的 Mock 数据**，这意味着：

1. **数据不持久化**：刷新页面后数据丢失
2. **无法跨设备共享**：每个浏览器/设备都是独立的数据
3. **无法多人协作**：第二个人加入时，看不到第一个人创建的组

### 为什么部署到 Vercel 后无法多人使用？

```
用户 A（手机）                用户 B（另一台设备）
    |                              |
    v                              v
创建组 G123456                  尝试加入 G123456
数据存在内存中 ─────X─────  数据在另一个内存中
（无法共享）                    （找不到组 G123456）
```

**Vercel 是无服务器部署**，每次请求可能是不同的实例，内存不共享。

## ✅ 解决方案

### 方案 1：接入真实后端（推荐）⭐

要实现真正的多人协作，**必须使用真实的后端数据库**。

#### 1.1 使用 Supabase（最简单）

**步骤**：

1. **创建 Supabase 项目**
   - 访问 [supabase.com](https://supabase.com)
   - 创建免费账户
   - 创建新项目

2. **创建数据表**
   ```sql
   -- 组表
   CREATE TABLE groups (
     id TEXT PRIMARY KEY,
     owner_id TEXT NOT NULL,
     created_at TIMESTAMP DEFAULT NOW(),
     expires_at TIMESTAMP NOT NULL,
     settled BOOLEAN DEFAULT FALSE,
     members TEXT[] DEFAULT ARRAY[]::TEXT[]
   );

   -- 菜单表
   CREATE TABLE group_menu_items (
     id TEXT PRIMARY KEY,
     group_id TEXT REFERENCES groups(id),
     name_display TEXT NOT NULL,
     price NUMERIC NOT NULL,
     note TEXT,
     status TEXT DEFAULT 'active',
     created_by TEXT NOT NULL,
     created_at TIMESTAMP DEFAULT NOW(),
     updated_at TIMESTAMP,
     updated_by TEXT
   );

   -- 轮次表
   CREATE TABLE rounds (
     id TEXT PRIMARY KEY,
     group_id TEXT REFERENCES groups(id),
     status TEXT DEFAULT 'open',
     created_by TEXT NOT NULL,
     created_at TIMESTAMP DEFAULT NOW(),
     closed_at TIMESTAMP
   );

   -- 订单项表
   CREATE TABLE round_items (
     id TEXT PRIMARY KEY,
     group_id TEXT REFERENCES groups(id),
     round_id TEXT REFERENCES rounds(id),
     user_id TEXT NOT NULL,
     name_display TEXT NOT NULL,
     price NUMERIC NOT NULL,
     qty INTEGER NOT NULL,
     note TEXT,
     created_at TIMESTAMP DEFAULT NOW(),
     updated_at TIMESTAMP,
     deleted BOOLEAN DEFAULT FALSE,
     deleted_by TEXT
   );
   ```

3. **安装 Supabase SDK**
   ```bash
   npm install @supabase/supabase-js
   ```

4. **创建 Supabase 客户端**
   创建文件 `src/api/supabase.ts`：
   ```typescript
   import { createClient } from '@supabase/supabase-js';

   const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
   const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

   export const supabase = createClient(supabaseUrl, supabaseKey);
   ```

5. **配置环境变量**
   创建 `.env.local`：
   ```
   VITE_SUPABASE_URL=你的项目URL
   VITE_SUPABASE_ANON_KEY=你的公开密钥
   ```

6. **替换 API 调用**
   修改 `src/api/mockService.ts`，将内存操作替换为 Supabase 调用：
   ```typescript
   // 之前
   export async function createGroup(ownerName: string) {
     // ... 内存操作
   }

   // 之后
   export async function createGroup(ownerName: string) {
     const { data, error } = await supabase
       .from('groups')
       .insert([{ ... }])
       .select();
     
     if (error) throw error;
     return data;
   }
   ```

7. **重新部署到 Vercel**
   在 Vercel 项目设置中添加环境变量：
   - `VITE_SUPABASE_URL`
   - `VITE_SUPABASE_ANON_KEY`

**优点**：
- ✅ 完全免费（Supabase 免费额度足够使用）
- ✅ 自动提供 REST API
- ✅ 实时数据同步（WebSocket）
- ✅ 自动备份
- ✅ 简单易用

#### 1.2 使用 Firebase

类似的步骤，使用 Firestore 作为数据库。

参考：https://firebase.google.com/docs/firestore

#### 1.3 自建后端

如果你有自己的服务器，可以用 Node.js + Express + PostgreSQL 搭建后端。

### 方案 2：本地测试方案（仅限开发）

如果只是想在**同一台电脑**上测试多人功能：

**使用不同浏览器的隐私模式**：
1. 正常窗口：创建组（用户A）
2. 隐私窗口：加入组（用户B）
3. 另一个浏览器：加入组（用户C）

⚠️ **注意**：这只能在本地开发环境 (`npm run dev`) 中使用，因为所有窗口连接到同一个开发服务器。**部署后无效**。

### 方案 3：localStorage 持久化（单设备）

如果你只需要在**同一设备的不同时间**使用（不需要多人同时协作），可以使用 localStorage 持久化数据。

这样可以：
- ✅ 刷新页面后数据不丢失
- ✅ 单人使用完全够用
- ❌ 仍然无法跨设备共享
- ❌ 无法多人同时协作

## 📋 快速决策指南

### 你需要什么？

#### 场景 1：只是自己用，记录点单
→ **当前版本就够用**（或添加 localStorage 持久化）

#### 场景 2：想和朋友一起在饭桌上点单（多人同时）
→ **必须接入 Supabase/Firebase**

#### 场景 3：想部署给很多人使用
→ **必须接入 Supabase/Firebase + 用户认证**

## 🚀 推荐方案

### 1. 立即可用（当前版本）
```bash
# 本地运行，单人使用
npm run dev
```

### 2. 接入 Supabase（30分钟）
按照上面的步骤 1.1，接入 Supabase，实现真正的多人协作。

### 3. 完整产品化（需要时间）
- 添加用户认证
- 添加数据备份
- 添加更多功能

## 📞 需要帮助？

如果你想接入 Supabase 但不知道如何操作，我可以：

1. **提供详细的代码改造方案**
2. **创建 Supabase API 替代文件**
3. **提供完整的部署教程**

只需要告诉我：
- 你想接入哪个后端（推荐 Supabase）
- 是否需要用户认证
- 是否需要实时同步

## 📊 对比表

| 特性 | Mock数据（当前） | localStorage | Supabase |
|------|-----------------|--------------|----------|
| 多人协作 | ❌ | ❌ | ✅ |
| 数据持久化 | ❌ | ✅ | ✅ |
| 跨设备共享 | ❌ | ❌ | ✅ |
| 实时同步 | ❌ | ❌ | ✅ |
| 开发难度 | 简单 | 简单 | 中等 |
| 部署成本 | 免费 | 免费 | 免费 |
| 适用场景 | 开发/演示 | 单人使用 | 多人生产 |

## 🎯 总结

**当前版本的定位**：
- ✅ 前端完整实现
- ✅ UI/UX 完善
- ✅ 业务逻辑正确
- ⚠️ 缺少持久化存储

**要实现真正的多人点单**：
- 必须接入真实后端（推荐 Supabase）
- 30分钟即可完成接入
- 完全免费

---

**需要我帮你接入 Supabase 吗？** 🙋‍♂️

