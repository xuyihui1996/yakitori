# 🔍 部署后功能不生效排查指南

## 问题：vercel --prod 后没有改变

可能的原因和解决方案：

---

## ✅ 检查清单

### 1️⃣ 确认部署是否真的成功了

```bash
# 查看最新部署
vercel ls --prod

# 检查部署详情
vercel inspect [deployment-url]
```

**检查项**：
- ✅ 是否显示最新的部署？
- ✅ 状态是否为 "READY"？
- ✅ 部署时间是否是刚才？

---

### 2️⃣ 检查是否有未提交的更改

```bash
git status
```

**如果有未提交的更改**：
```bash
# 查看哪些文件被修改了
git diff

# 提交所有更改
git add .
git commit -m "feat: 添加菜单扫描功能（完整版）"

# 重新部署
git push origin main
# 或
vercel --prod
```

---

### 3️⃣ 检查环境变量是否设置

**这是最常见的问题！**

1. 访问：https://vercel.com/dashboard
2. 进入你的项目
3. Settings → Environment Variables
4. 检查是否有 `GOOGLE_APPLICATION_CREDENTIALS`

**如果没有或值不对**：
```
Name: GOOGLE_APPLICATION_CREDENTIALS
Value: [粘贴 yakitori-477003-94640fab8889.json 的完整内容]
Environment: Production ✅
```

**设置后必须重新部署！**
```bash
# 方法 A: 触发新部署
git commit --allow-empty -m "chore: redeploy with env vars"
git push origin main

# 方法 B: 在 Vercel Dashboard 重新部署
# Deployments → 最新部署 → ... → Redeploy
```

---

### 4️⃣ 检查浏览器缓存

```bash
# 访问你的网站时：
# 1. 打开开发者工具 (F12)
# 2. 右键刷新按钮
# 3. 选择 "清空缓存并硬性重新加载"

# 或者用隐身模式访问
```

---

### 5️⃣ 检查是否访问了旧的 URL

**常见错误**：访问的是旧的预览 URL，而不是生产环境 URL

**生产环境 URL 格式**：
```
https://your-project.vercel.app  ← 这是生产环境
```

**预览 URL 格式**（不要访问这个）：
```
https://your-project-xxxxx.vercel.app  ← 这是预览版本
```

**检查方法**：
```bash
# 查看生产环境 URL
vercel ls --prod

# 或在 Vercel Dashboard 查看
# 项目首页 → Visit 按钮
```

---

### 6️⃣ 检查 API 文件是否正确部署

访问：`https://your-project.vercel.app/api/parse-menu`

**预期行为**：
- ❌ 不应该返回 404
- ✅ 应该返回 405 (Method Not Allowed) 或其他错误
- ✅ 说明 API 文件已正确部署

**如果返回 404**：
- API 文件没有正确部署
- 检查 `api/parse-menu.ts` 是否被提交到 git

```bash
# 检查文件是否在 git 中
git ls-files | grep "api/parse-menu.ts"

# 如果没有，添加它
git add api/parse-menu.ts
git commit -m "fix: 添加 API 文件"
git push origin main
```

---

### 7️⃣ 检查前端文件是否部署

**检查方法**：
1. 打开浏览器开发者工具 (F12)
2. Sources 标签
3. 查找 `MenuScanner.tsx` 或相关代码
4. 看是否有"扫描菜单"相关代码

**如果没有**：
```bash
# 确认文件在 git 中
git ls-files | grep MenuScanner

# 查看最后一次提交
git log --oneline -1

# 查看提交内容
git show HEAD --stat
```

---

## 🎯 最可能的问题和解决方案

### 问题 1: 环境变量未设置（最常见）

**症状**：
- 前端显示"扫描菜单"按钮 ✅
- 点击后可以上传图片 ✅
- 但识别失败，提示 "OCR service not configured" ❌

**解决**：
```bash
# 1. 在 Vercel Dashboard 设置环境变量
# 2. 触发重新部署
git commit --allow-empty -m "chore: redeploy"
git push origin main
```

---

### 问题 2: 代码未完全提交

**症状**：
- 网站没有"扫描菜单"按钮 ❌

**解决**：
```bash
# 查看未提交的文件
git status

# 查看修改内容
git diff

# 提交所有更改
git add .
git commit -m "feat: 添加菜单扫描功能（完整）"
git push origin main
```

---

### 问题 3: 浏览器缓存

**症状**：
- 本地测试正常 ✅
- 但生产环境看不到新功能 ❌

**解决**：
- 强制刷新：Ctrl+Shift+R (Windows/Linux) 或 Cmd+Shift+R (Mac)
- 或使用隐身模式访问

---

## 📊 完整排查流程

```bash
# 1. 检查 git 状态
echo "=== Git 状态 ==="
git status

# 2. 检查最后提交
echo -e "\n=== 最后提交 ==="
git log --oneline -1
git show HEAD --stat

# 3. 检查 vercel 部署
echo -e "\n=== Vercel 部署状态 ==="
vercel ls --prod

# 4. 检查关键文件是否在 git 中
echo -e "\n=== 关键文件检查 ==="
echo "MenuScanner.tsx:"
git ls-files | grep MenuScanner || echo "❌ 未找到"
echo "parse-menu.ts:"
git ls-files | grep "api/parse-menu.ts" || echo "❌ 未找到"
echo "vercel.json:"
git ls-files | grep vercel.json || echo "❌ 未找到"

# 5. 如果有未提交的内容，提交并重新部署
if [[ -n $(git status -s) ]]; then
  echo -e "\n⚠️  有未提交的更改！"
  git add .
  git commit -m "feat: 添加菜单扫描功能（完整）"
  git push origin main
  echo "✅ 已重新部署"
else
  echo -e "\n✅ 所有文件已提交"
fi
```

---

## 🆘 如果还是不行

### 最终方案：查看 Vercel 日志

1. **访问 Vercel Dashboard**
   - https://vercel.com/dashboard

2. **进入项目 → Deployments**
   - 查看最新部署的详细信息

3. **检查构建日志**
   - 点击最新部署
   - 查看 "Build Logs"
   - 看是否有错误

4. **检查函数日志（重要）**
   - Functions 标签
   - 选择 `/api/parse-menu`
   - 查看运行日志
   - 看是否有错误信息

5. **常见日志错误**：
   ```
   ❌ "GOOGLE_APPLICATION_CREDENTIALS not set"
   → 环境变量未设置或未重新部署

   ❌ "Module not found: Can't resolve..."
   → 依赖未正确安装

   ❌ "PERMISSION_DENIED: This API method requires billing"
   → Google Cloud 未启用计费
   ```

---

## ✅ 验证部署成功

所有这些都应该正常：

### 前端检查
- [ ] 网站可以正常访问
- [ ] 显示"扫描菜单"按钮（绿色）
- [ ] 点击后弹窗打开
- [ ] 可以选择/上传图片

### API 检查
```bash
# 访问 API 端点应该返回 405（不是 404）
curl -X GET https://your-project.vercel.app/api/parse-menu
# 预期: {"error":"Method not allowed"}
```

### 功能检查
- [ ] 上传图片后显示"识别中..."
- [ ] 几秒后显示识别结果
- [ ] 可以编辑识别结果
- [ ] 可以批量添加菜品

---

**运行上面的排查流程，告诉我结果，我来帮你进一步排查！** 🔍



