# 📸 菜单扫描功能使用指南

## 功能介绍

**菜单扫描功能** 允许用户通过拍照或上传菜单图片，自动识别菜品名称和价格，极大提升点单效率！

### ✨ 核心特性

- 📷 **支持拍照**: 使用手机相机直接拍摄菜单
- 📁 **支持上传**: 从相册选择已有的菜单图片
- 🤖 **智能识别**: 基于 Google Cloud Vision API 的 OCR 技术
- 🎯 **准确率高**: 针对日式菜单优化，识别率 **50%+**
- ✅ **人工确认**: 识别结果可编辑，确保准确性
- ⚡ **批量添加**: 一次扫描可添加多个菜品

---

## 🚀 使用流程

### 1️⃣ 进入点单页面

在组主页（Group Home）的"点单区"，点击 **"扫描菜单"** 按钮（绿色按钮）。

### 2️⃣ 拍照或上传图片

- **拍照**: 点击"拍照"按钮，使用手机相机拍摄菜单
- **上传**: 点击"上传图片"按钮，从相册选择菜单图片

**拍摄建议**：
- ✅ 确保菜单图片清晰、光线充足
- ✅ 菜品名称和价格都在画面内
- ✅ 尽量避免倾斜和遮挡
- ✅ 如果菜单很长，可以**分多次拍摄**（推荐！）

### 3️⃣ 开始识别

上传图片后，点击 **"开始识别"** 按钮，等待 OCR 处理（通常 3-10 秒）。

### 4️⃣ 确认和编辑结果

识别完成后，会显示识别出的菜品列表。每个菜品包含：
- **菜品名称**: 自动识别的名称
- **价格**: 自动识别的价格
- **置信度标记**: 
  - ⭐ **完美识别**: 高置信度，自动选中
  - ⚠️ **建议确认**: 低置信度，需要人工检查

**操作选项**：
- ✅ **勾选/取消**: 选择要添加的菜品
- ✏️ **编辑**: 点击编辑按钮修改名称或价格
- 🔄 **重新扫描**: 如果结果不满意，可以重新拍照

### 5️⃣ 确认添加

选择好要添加的菜品后，点击 **"确认添加 (N 项)"** 按钮：
- 系统会自动将选中的菜品添加到菜单
- 同时为当前用户添加 1 份订单
- 如果菜品已存在，会自动使用现有价格

---

## 📋 Vercel 部署配置

### 1. 环境变量设置

在 Vercel 项目设置中，添加以下环境变量：

#### 方式 A：使用 JSON 密钥文件（推荐）

```bash
# 环境变量名
GOOGLE_APPLICATION_CREDENTIALS

# 环境变量值：将 yakitori-477003-94640fab8889.json 的完整内容复制粘贴
# 内容格式示例：
{
  "type": "service_account",
  "project_id": "yakitori-477003",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "...",
  ...
}
```

#### 方式 B：使用单独的环境变量

如果方式 A 不工作，可以单独设置每个字段：

```bash
GOOGLE_CLOUD_PROJECT_ID=yakitori-477003
GOOGLE_CLOUD_CLIENT_EMAIL=your-service-account@yakitori-477003.iam.gserviceaccount.com
GOOGLE_CLOUD_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
```

### 2. Vercel 配置文件

确保 `vercel.json` 包含以下配置：

```json
{
  "functions": {
    "api/parse-menu.ts": {
      "memory": 1024,
      "maxDuration": 30
    }
  },
  "env": {
    "GOOGLE_APPLICATION_CREDENTIALS": "@google-application-credentials"
  }
}
```

### 3. API Body Size Limit

Vercel 默认限制请求体大小为 4.5MB，对于图片上传通常足够。如果需要更大的限制，可以在 `vercel.json` 中添加：

```json
{
  "functions": {
    "api/parse-menu.ts": {
      "memory": 1024,
      "maxDuration": 30,
      "maxBodySize": "10mb"
    }
  }
}
```

---

## 🛠️ 本地开发配置

### 1. 安装依赖

```bash
npm install formidable @types/formidable
```

### 2. 设置 Google Cloud 凭证

**方式 A：环境变量（推荐）**

```bash
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/yakitori-477003-94640fab8889.json
```

**方式 B：放在项目根目录**

将 `yakitori-477003-94640fab8889.json` 放在项目根目录，代码会自动发现。

### 3. 启动开发服务器

```bash
npm run dev
```

### 4. 测试 OCR API

```bash
# 方式 1：使用测试脚本
npm run parse:menu path/to/menu-image.jpg

# 方式 2：使用区域切分脚本（推荐！识别率更高）
npm run parse:regions region1.png region2.png region3.png
```

---

## 💡 使用技巧

### 📸 拍摄技巧

1. **分区拍摄**（强烈推荐）：
   - ❌ 不要一次拍整张菜单
   - ✅ 将菜单分成 2-3 个区域分别拍摄
   - 🎯 每个区域包含 5-15 个菜品为佳
   - 📈 识别率可从 10% 提升到 **50%+**！

2. **确保清晰**：
   - 光线充足
   - 对焦清晰
   - 避免反光和阴影

3. **垂直拍摄**：
   - 相机与菜单平行
   - 避免倾斜角度

### ✏️ 编辑技巧

1. **快速编辑**：
   - 对于识别不准确的项，点击编辑按钮
   - 修改名称和价格
   - 保存后自动更新置信度

2. **批量处理**：
   - 先勾选所有准确的项
   - 编辑不准确的项
   - 一次性添加

### 🎯 识别优化

当前识别率统计（基于实测）：
- **完整图片**: ~10%
- **区域切分**: ~50%+
- **手动调整**: ~100%

**最佳实践**：
1. 使用区域切分拍摄 → 50% 自动识别
2. 人工编辑不准确项 → 剩余 50% 快速修正
3. **总体效率提升 5 倍+**！

---

## 🐛 常见问题

### Q1: 为什么识别结果为空？

**可能原因**：
- 图片模糊或光线不足
- 菜单文字太小
- 格式不规则（如手写菜单）

**解决方法**：
- 重新拍照，确保清晰
- 尝试分区拍摄
- 使用手动添加功能

### Q2: 为什么价格识别不准确？

**可能原因**：
- 价格使用了特殊格式（如 "时价"、"MP"）
- 价格和菜名混在一起
- 存在干扰信息（如税费说明）

**解决方法**：
- 使用编辑功能手动修正
- 确保价格在独立的列

### Q3: API 调用失败怎么办？

**检查项**：
1. Vercel 环境变量是否正确设置
2. Google Cloud Vision API 是否启用计费
3. 网络连接是否正常

**调试**：
- 查看 Vercel 函数日志（Functions → Logs）
- 检查浏览器控制台错误信息

### Q4: 上传图片失败？

**可能原因**：
- 图片文件太大（超过 10MB）
- 文件格式不支持

**解决方法**：
- 压缩图片（推荐 < 5MB）
- 使用常见格式（JPG、PNG）

---

## 📊 功能对比

| 功能 | 手动添加 | 菜单扫描 |
|------|---------|---------|
| **速度** | 慢（每项 ~20s） | 快（整页 ~10s） |
| **准确率** | 100% | 50%+（可编辑） |
| **效率** | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **适用场景** | 少量菜品 | 大量菜品 |
| **推荐指数** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 🎉 未来优化

计划中的改进：
- [ ] 支持更多语言（中文、韩文）
- [ ] 提升识别率到 70%+
- [ ] 支持手写菜单识别
- [ ] 添加菜品图片识别
- [ ] 支持菜单模板（常见连锁店）

---

## 📞 技术支持

遇到问题？请查看：
- 📄 [OCR使用指南.md](./OCR使用指南.md)
- 📄 [区域切分效果分析.md](./区域切分效果分析.md)
- 📄 [优化策略总结.md](./优化策略总结.md)

---

**祝您使用愉快！🎊**

