# 菜品改名功能实现说明

## ✅ 已完成的功能

### 1. 数据库迁移
- **文件**: `supabase_menu_rename_migration.sql`
- **内容**:
  - 添加 `round_items.menu_item_id`（关联菜单项）
  - 添加 `round_items.user_name_snapshot`（结账时昵称快照）
  - 添加审计字段 `updated_at`, `updated_by`
  - 创建唯一索引 `uniq_menu_name_active`（同组内active状态菜名唯一）
  - 创建触发器 `trg_menu_update_lock`（结账后禁止改名）
  - 添加RLS策略（允许本组成员更新菜单项和订单项）

### 2. 名称规范化工具
- **文件**: `src/utils/nameNormalize.ts`
- **功能**: 统一处理全半角、空白、分隔符等

### 3. 后端API（Supabase）
- **文件**: `src/api/supabaseService.ts`
- **新增函数**: `updateMenuItemName(groupId, menuItemId, newName, userId)`
- **功能**:
  - 校验组未结账
  - 规范化名称并检查冲突
  - 更新菜单项名称
  - 统一回写该组所有订单项名称

### 4. 后端API（Mock）
- **文件**: `src/api/mockService.ts`
- **新增函数**: `updateMenuItemName(groupId, menuItemId, newName, userId)`
- **功能**: 同Supabase版本，适配内存存储

### 5. 结账逻辑增强
- **Supabase**: `finalizeCheckout` 函数中添加昵称快照和名称快照
- **Mock**: `settleGroup` 函数中添加昵称快照和名称快照

### 6. 前端UI
- **文件**: `src/components/MenuPicker.tsx`
- **功能**:
  - 添加编辑按钮（全员可见，已结账时禁用）
  - 内联编辑输入框
  - 处理409冲突错误提示
  - 处理403结账后禁止改名错误

### 7. Store集成
- **文件**: `src/store/groupStore.ts`
- **新增action**: `updateMenuItemName(menuItemId, newName)`

### 8. 类型定义
- **文件**: `src/types/index.ts`
- **新增字段**:
  - `RoundItem.menuItemId`
  - `RoundItem.userNameSnapshot`
  - `RoundItem.updatedBy`

## 📋 使用步骤

### 1. 执行数据库迁移
在 Supabase SQL Editor 中执行 `supabase_menu_rename_migration.sql`

### 2. 功能验证清单

#### ✅ 菜品改名权限
- [ ] 任何组成员都可以修改菜单项名称
- [ ] 改名按钮对所有成员可见（已结账时禁用）

#### ✅ 冲突处理
- [ ] 改名为已存在的菜名 → 409错误 + "菜名已存在，请重新命名"
- [ ] 同组内active状态菜名唯一（大小写不敏感）

#### ✅ 改名影响范围
- [ ] 改名后，该组所有轮的订单项名称同步更新
- [ ] 历史菜单模板（restaurant_menu）不受影响
- [ ] 结账后禁止改名（触发器拦截）

#### ✅ 昵称快照
- [ ] 结账时保存用户昵称到 `user_name_snapshot`
- [ ] 结账后历史订单显示使用 `user_name_snapshot`
- [ ] 用户改名不影响历史订单显示

## 🔍 关键实现细节

### 名称规范化
所有创建/重命名入口统一调用 `normalizeDishName()`，确保：
- 全半角归一（NFKC）
- 空白压缩
- 分隔符统一（·和/转为・）

### 冲突检测
- 前端：规范化后比较（大小写不敏感）
- 后端：数据库唯一索引 + 应用层检查

### 订单项名称同步
- 通过 `menu_item_id` 关联菜单项和订单项
- 改名时批量更新所有关联订单项
- 仅未结账组允许更新

### 结账快照
- 结账前统一更新订单项名称（确保与最新菜单名一致）
- 结账时保存用户昵称快照
- 结账后禁止修改菜单名（触发器）

## ⚠️ 注意事项

1. **数据库迁移**: 必须先执行SQL脚本，否则功能无法正常工作
2. **RLS策略**: 确保RLS策略允许本组成员更新菜单项和订单项
3. **历史数据**: 回填脚本会尝试匹配历史订单项的 `menu_item_id`，但可能无法完全匹配
4. **Mock服务**: Mock服务中需要手动维护 `menuItemId` 关联，通过名称+价格匹配

## 🐛 已知限制

1. Mock服务中，订单项的 `menuItemId` 可能为空（历史数据）
2. 改名时通过名称+价格匹配更新订单项，可能不够精确
3. RLS策略需要根据实际成员表结构调整

## 📝 后续优化建议

1. 添加改名历史记录（审计日志）
2. 优化订单项与菜单项的关联机制
3. 添加批量改名功能
4. 优化RLS策略，更细粒度的权限控制

